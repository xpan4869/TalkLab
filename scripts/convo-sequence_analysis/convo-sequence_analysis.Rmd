---
title: "Conversational Sequence Analysis"
author: "Yolanda Pan"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

This following analysis investigates the structural and temporal dynamics of conversational turns to identify behavioral markers of good conversationalist. Specifically, this analysis incorporates:

1. **Basic Statistics for Sequence Types:** The average and standard deviation of *Question* and *Disclose* type, and their correlation.
2.  **Micro-Structural Dynamics (Adjacency Pairs):** How do conversational turns chain together? Specifically, does the probability of a response depend on the type of antecedent (e.g., Question vs. Disclosure)?
3.  **Macro-Temporal Dynamics (Escalation):** How does the distribution of disclosure evolve from the beginning to the end of an interaction?

```{r libraries, echo = FALSE}
library(tidyverse)  # Data manipulation and plotting
library(viridis)    # Accessible color scales
library(knitr)      # For nice tables
library(gridExtra)  # For arranging plots
library(lmerTest)   # For mixed-effects modeling concepts
library(scales)     # For formatting percentages
```

```{r load_data, echo = FALSE}
# Define path
file_path <- "../../data/Talklab_CANDOR_take_home_data.csv"

# Load and Clean Data
df <- read_csv(file_path) %>%
  slice(-1) %>%                                      # Remove description row
  mutate(
    sequence_start = as.numeric(sequence_start),     # Ensure numeric types
    sequence_end = as.numeric(sequence_end),
    sequence_duration = as.numeric(sequence_duration),
    sequence_type = str_trim(sequence_type)          # Trim whitespace
  ) %>%
  arrange(interaction_id, sequence_start)            # Sort by time

# Feature Engineering: Sequence Transitions
df <- df %>%
  group_by(interaction_id) %>%
  mutate(
    next_type = lead(sequence_type),                 # What happens next?
    next_speaker = lead(initiating_speaker),         # Who speaks next?
    speaker_change = ifelse(initiating_speaker == next_speaker, "Same Speaker", "Switch Speaker")
  ) %>%
  ungroup()
```

## 1. Basic Information

### Exploration

```{r, echo = FALSE}
kable(df %>%
  group_by(interaction_id) %>%          # group by each dyad / convo
  summarize(
    total_Q = sum(sequence_type == "question"),   # count questions
    total_D = sum(sequence_type == "disclosure")  # count disclosures
  ) %>%
  summarize(
    avg_Q = mean(total_Q),
    avg_D = mean(total_D),
    sd_Q = sd(total_Q),
    sd_D = sd(total_D)
  ))
```

On average, conversations contained slightly more disclosures than questions. The mean number of disclosures was about 32 per interaction, compared with about 26 questions. Variability was higher for questions (SD ≈ 16) than for disclosures (SD ≈ 9), indicating that some conversations were highly question-heavy while others had relatively few. Disclosures, by contrast, were more consistently present across conversations.

```{r, echo = FALSE}
counts_by_interaction <- df %>%
  group_by(interaction_id) %>%
  summarize(
    total_Q = sum(sequence_type == "question"),
    total_D = sum(sequence_type == "disclosure")
  )

counts_by_interaction %>%
  ggplot(aes(x = total_Q, y = total_D)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  labs(
    title = "Relationship Between Questions and Disclosures",
    x = "Total Questions",
    y = "Total Disclosures"
  )
```

Across interactions, the total number of disclosures did not increase as a function of the total number of questions. The fitted regression line was flat, indicating that question frequency was not a reliable predictor of overall disclosure levels.

### Visualization

To establish a baseline understanding of conversational flow, I visualize the sequence duration and type for a random sample of dyads.

```{r viz_rhythm, fig.width=12, fig.height=8, echo = FALSE}
# 1. Randomly sample 6 unique Interaction IDs
set.seed(42) 
sampled_ids <- sample(unique(df$interaction_id), 6)

# 2. Plot Gantt Charts
df %>%
  filter(interaction_id %in% sampled_ids) %>%
  ggplot(aes(y = initiating_speaker, x = sequence_start, xend = sequence_end, color = sequence_type)) +
  geom_segment(linewidth = 4, alpha = 0.8) +
  scale_color_manual(values = c("question" = "blue", "disclosure" = "orange")) +
  
  # Facet Wrap creates the 2x3 grid
  facet_wrap(~ interaction_id, ncol = 3, scales = "free_x") +
  
  theme_minimal() +
  labs(
    title = "Figure 1: Conversation Rhythm (Gantt Charts)",
    subtitle = "Visualizing sequence density (Orange = Disclosure, Blue = Question)",
    x = "Time (seconds)",
    y = "Speaker",
    color = "Sequence Type"
  ) +
  theme(legend.position = "bottom", strip.text = element_text(size = 8))
```

Figure 1 reveals distinct interaction styles, ranging from rapid, short exchanges to extended blocks of sustained disclosure. Some dyads are predominantly question-driven, others are disclosure-heavy, and still others maintain a more balanced pattern. In some cases, the interaction even resembles an interview, with one partner actively eliciting information from the other. This variance suggests that the rhythm of interaction—rather than content alone—may be a distinguishing feature of conversation quality.


## 2. Micro-Structural Analysis: Adjacency pairs

This section calculates the conditional probability of a specific response type given an antecedent. To isolate true interaction from monologue, I distinguish between transitions where the speaker holds the floor ("Same Speaker") versus exchanges ("Switch Speaker").

```{r viz_structure, echo = FALSE}
# Filter for valid transitions
trans_data <- df %>%
  filter(!is.na(next_type) & !is.na(speaker_change)) %>%
  count(sequence_type, speaker_change, next_type) %>%
  group_by(sequence_type) %>%
  mutate(prob = n / sum(n)) %>% # Calculate probability relative to the Current Type
  ungroup()

# Plot Stacked Bar Chart
ggplot(trans_data, aes(x = sequence_type, y = prob, fill = next_type, alpha = speaker_change)) +
  geom_bar(stat = "identity", position = "fill", color = "black") +
  
  # Use transparency to distinguish Monologue vs Interaction
  scale_alpha_manual(values = c("Same Speaker" = 0.7, "Switch Speaker" = 1.0)) +
  scale_fill_manual(values = c("question" = "blue", "disclosure" = "orange")) +
  
  # Add labels
  geom_text(aes(label = ifelse(prob > 0.05, scales::percent(prob, accuracy = 1), "")), 
            position = position_stack(vjust = 0.5), size = 4, color = "white") +
  
  theme_minimal() +
  labs(
    title = "Figure 2: The Anatomy of a Transition",
    subtitle = "Conditional probability of next turn type (Solid = Interaction, Faded = Monologue)",
    x = "Current Sequence Type",
    y = "Probability",
    fill = "Next Sequence Type",
    alpha = "Turn Dynamic"
  )
```

Figure 2 shows that when a question is followed by another question, this transition most often occurs within the same speaker. Surprisingly, 52% of all Question → Question sequences are self-generated rather than produced by the partner. This indicates that questions are frequently used to continue speaking, often through multi-part or elaborating inquiries, rather than immediately handing over the floor.

After a disclosure, the next turn is most likely to be another disclosure, regardless of whether the same speaker continues or the floor switches. This pattern shows that disclosure tends to sustain itself and create momentum. Once sharing begins, it is likely to continue, forming a stable rhythm of reciprocal or ongoing disclosure.


## 3. Temporal Analysis: The Escalation Arc

To understand how conversations evolve, I normalized interaction time (0-100%) and divided each conversation into 5 phases. This resolution captures the "warm-up" trajectory while smoothing sequence-level noise.

### 3.1 Global Temporal Patterns

First, I examine the aggregate trend across all dyads to determine if a "warm-up effect" exists.

```{r viz_temporal, echo = FALSE}
# Binning Logic: Divide every conversation into 5 equal phases
df_temporal <- df %>%
  group_by(interaction_id) %>%
  mutate(
    progress = (sequence_start - min(sequence_start)) / (max(sequence_end) - min(sequence_start)),
    phase = cut(progress, breaks = 5, labels = FALSE) 
  ) %>%
  group_by(interaction_id, phase) %>%
  summarize(
    disclosure_ratio = mean(sequence_type == "disclosure"),
    .groups = "drop"
  )

# Plot the Trajectory
ggplot(df_temporal, aes(x = factor(phase), y = disclosure_ratio)) +
  # Individual trajectories (Background context)
  geom_line(aes(group = interaction_id), color = "gray", alpha = 0.2) +
  # Average "Warm-up" Arc
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "orange", linewidth = 2) +
  stat_summary(fun = mean, geom = "point", color = "orange", size = 4) +
  
  theme_minimal() +
  labs(
    title = "Figure 3: The Temporal Arc of Intimacy",
    subtitle = "Conversations naturally 'warm up' (Positive Slope) from Phase 1 to 5",
    x = "Conversation Phase (1=Start, 5=End)",
    y = "Proportion of Disclosure"
  )
```

Figure 3 shows how the proportion of disclosure changes across five equal segments of each conversation. The average line (in orange) rises from about 0.48 in Phase 1 to a peak of roughly 0.70 in Phase 4, followed by a slight decline in Phase 5. Most individual conversations (gray lines) show some upward movement from early to later phases, even though trajectories vary.

The dominant pattern is a positive slope from the beginning of the interaction into the middle phases. Disclosure gradually becomes more frequent as conversations unfold. The last segment shows a small drop, but remains higher than the starting level.

This suggests that conversations naturally “warm up.” Early stages appear to involve less personal sharing, whereas middle and later phases tend to sustain longer or more frequent disclosures. The slight decline at the end may reflect wrap-up or time constraints, rather than a drop in intimacy per se.

One potential representation of each conversation is to label each trajectory (i.e., first up-middle down-final up) to see they show extinct differences in psychological outcomes.

### 3.2 Individual Speaker

To link temporal dynamics to "Good Conversationalist", I disaggregate the analysis by speaker. I calculate an **Escalation Slope** for each participant, representing the rate at which they deepen the conversation over time.

```{r viz_temporal_speaker, echo = FALSE}
# 1. Binning Logic (Per Speaker)
df_temporal_speaker <- df %>%
  group_by(interaction_id) %>%
  mutate(
    progress = (sequence_start - min(sequence_start)) / (max(sequence_end) - min(sequence_start)),
    phase = cut(progress, breaks = 5, labels = FALSE) 
  ) %>%
  group_by(interaction_id, initiating_speaker, phase) %>%
  summarize(
    disclosure_ratio = mean(sequence_type == "disclosure"),
    .groups = "drop"
  )

# 2. Calculating the Individual Slope (The "Strategy" Variable)
# Positive Slope = Deepener strategy. Flat/Negative Slope = Stagnant strategy.
speaker_slopes <- df_temporal_speaker %>%
  group_by(interaction_id, initiating_speaker) %>%
  summarize(
    escalation_slope = coef(lm(disclosure_ratio ~ phase))[2],
    avg_disclosure = mean(disclosure_ratio),
    .groups = "drop"
  )

# 3. Visualization
sample_ids <- sample(unique(df$interaction_id), 6)

df_temporal_speaker %>%
  filter(interaction_id %in% sample_ids) %>%
  ggplot(aes(x = factor(phase), y = disclosure_ratio, color = initiating_speaker, group = initiating_speaker)) +
  geom_line(linewidth = 1.5, alpha = 0.8) +
  facet_wrap(~interaction_id) +
  scale_color_manual(values = c("left" = "darkgreen", "right" = "maroon")) +
  theme_minimal() +
  labs(
    title = "Figure 4: Speaker Strategies (Escalation Slopes)",
    subtitle = "Comparing how different speakers drive depth over time",
    x = "Conversation Phase (1-5)",
    y = "Disclosure Ratio"
  )
```

Figure 4 demonstrates that escalation strategies often differ within dyads. Future work could classify trajectory shapes (e.g., rising, convex, plateauing) and test whether alignment or synchrony predicts relational outcomes.

## 4. Hypothesis Proposal & Analysis Plan

Based on the structural finding that $D \rightarrow D$ represents a stable, high-intimacy state, and the temporal finding that conversations follow a distinct escalation arc, I propose two hypotheses to predict "Good Conversationalist" ratings.

**H1: The Reciprocity Hypothesis**

An individual's Reciprocity Score, the probability of meeting a partner's disclosure with a reciprocal disclosure, will be a significantly stronger predictor of partner ratings than their Responsiveness Score, the probability of self-disclosure after a partner's question.

While answering questions ($Q \rightarrow D$) satisfies baseline politeness norms, it can establishes an asymmetric "Interview" dynamic. True connection is defined by the symmetric exchange of vulnerability ($D \rightarrow D$). Therefore, the ability to sustain a reciprocity loop represents a higher-order social skill than basic responsiveness.

```{r eval=FALSE}
model_h1 <- lmer(partner_rating ~ reciprocity_score + responsiveness_score +
    (1 | interaction_id), data = speaker_level_data)

summary(model_h1)
```

**H2: The Escalation Hypothesis (Timing)**

Controlling for total disclosure volume, escalation slope (rate of increase in disclosure) will predict “Good Conversationalist” ratings.

Conversations benefit from pacing. Social Penetration Theory emphasizes gradual deepening. Two failure modes can be either too much sharing too early or never reach the depth.

```{r eval=FALSE}
model_h2 <- lmer(partner_rating ~ escalation_slope + total_disclosure_ratio + (1 | interaction_id),
                 data = speaker_level_data)

summary(model_h2)
```